<!DOCTYPE html>
<meta charset="utf-8">
<title>Experiment</title>
<style>
  html,
  body {
    height: 100%;
    width: 100%;
  }

  .node rect {
    cursor: move;
    fill-opacity: .9;
    shape-rendering: crispEdges;
  }

  .node text {
    pointer-events: none;
    text-shadow: 0 1px 0 #fff;
  }

  .link {
    fill: none;
    stroke: #000;
    stroke-opacity: .2;
  }

  .link:hover {
    stroke-opacity: .5;
  }
</style>

<body>

  <div id="chart" style="width:100%; height: 100%"></div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="sankey.js"></script>
  <script>

    var units = "units";

    var margin = { top: 10, right: 10, bottom: 10, left: 10 },
      width = 1200 - margin.left - margin.right,
      height = 740 - margin.top - margin.bottom;

    const color = d3.scale.category20();

    // append the svg canvas to the page
    var svg = d3.select("#chart").append("svg")
      .attr("width", "100%")
      .attr("height", "100%")
      .call(d3.behavior.zoom().on("zoom", function () {
        svg.attr("transform", "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")")
      }))
      .append("g")
      .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");


    // load the data
    const generate = (graph, settings) => {
      var nodeMap = {};

      const times = graph.nodes.map(n => n.tx.time);
      const timeMin = Math.min(...times);
      const timeMax = Math.max(...times);
      const timeInterval = timeMax - timeMin;
      console.log(timeMin, timeMax, timeInterval);


      graph.nodes = graph.nodes.map(x => ({
        ...x,
        x: (x.tx.time - timeMin) / timeInterval * width,
        y: x.tx.confirmations % height
      }));
      graph.nodes.forEach(function (x) { nodeMap[x.name] = x; });
      graph.links = graph.links.map(x => ({
        source: nodeMap[x.source],
        target: nodeMap[x.target],
        value: x.value,
        wallet: x.wallet,
      }));

      // add in the nodes
      var node = svg.append("g").selectAll(".node")
        .data(graph.nodes)
        .enter().append("g")
        .attr("class", "node")
        .attr("transform", function (d) {
          return "translate(" + d.x + "," + d.y + ")";
        });



      // add the rectangles for the nodes
      node.append("rect")
        .attr("height", 10)
        .attr("width", 20)
        .style("fill", function (d) {
          return 'gray';
        })
        .on('click', d => {
          if (event.ctrlKey) {
            console.log(event);
            window.open(settings["block-explorer-url"] + d.name, "_blank")
          }
        })
        .style("stroke", function (d) {
          return d3.rgb(d.color).darker(2);
        })
        .append("title")
        .text(function (d) {
          return d.id + "\n" + d.value;
        });


      const link = d3.linkRadial();

      let links = svg.append('g').selectAll('.link')
        .data(graph.links)
        .join("path")
        .attr("", link)


        // .enter().append('svg:line')
        // .attr("class", "link")
        // .attr("style", "stroke:black")
        // .attr("x1", d => d.source.x)
        // .attr("y1", d => d.source.y)
        // .attr("x2", d => d.target.x)
        // .attr("y2", d => d.target.y)
    };

    const ws = new WebSocket('ws://localhost:8080');
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);

      generate(data.model, data.settings);
    };

    ws.onopen = (event) => {
      ws.send("test");
    }
  </script>

</body>

</html>